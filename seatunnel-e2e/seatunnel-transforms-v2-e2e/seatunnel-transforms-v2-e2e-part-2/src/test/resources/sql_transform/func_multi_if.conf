#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
######
###### This config file is a demonstration of streaming processing in seatunnel config
######

env {
  parallelism = 1
  job.mode = "BATCH"
  checkpoint.interval = 10000
}

source {
  FakeSource {
    plugin_output = "fake"
    schema = {
      fields {
        id = "int"
        age = "int"
        score = "double"
        name = "string"
      }
    }
    rows = [
      {fields = [1, 15, 85.5, "Alice"], kind = INSERT}
    ]
  }
}

transform {
  Sql {
    plugin_input = "fake"
    plugin_output = "fake1"
    query = """
      SELECT
        id,
        age,
        score,
        name,
        MULTI_IF(age < 18, 'Minor', age < 30, 'Young Adult', age < 40, 'Adult', 'Senior') as age_category,
        MULTI_IF(score >= 90, 'A', score >= 80, 'B', score >= 70, 'C', score >= 60, 'D', 'F') as grade,
        MULTI_IF(score >= 90, 'excellent', 'pass') as grade_category
      FROM fake
    """
  }
}

sink {
  Assert {
    plugin_input = "fake1"
    rules = {
      row_rules = [
        {
          rule_type = "MIN_ROW"
          rule_value = 1
        },
        {
          rule_type = "MAX_ROW"
          rule_value = 1
        }
      ],
      field_rules = [
        {
          field_name = "id"
          field_type = "int"
          field_value = [
            {equals_to = 1}
          ]
        },
        {
          field_name = "age_category"
          field_type = "string"
          field_value = [
            {equals_to = "Minor"}
          ]
        },
        {
          field_name = "grade"
          field_type = "string"
          field_value = [
            {equals_to = "B"}
          ]
        },
        {
          field_name = "grade_category"
          field_type = "string"
          field_value = [
            {equals_to = "pass"}
          ]
        }
      ]
    }
  }
}
